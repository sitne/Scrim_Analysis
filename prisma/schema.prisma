generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// チーム管理
// ============================================

model Team {
  id          String   @id @default(cuid())
  name        String
  inviteCode  String   @unique @default(cuid())
  createdAt   DateTime @default(now())
  
  members     TeamMember[]
  matches     Match[]
}

model TeamMember {
  id       String   @id @default(cuid())
  teamId   String
  userId   String   // Supabase Auth user ID
  role     String   @default("member") // "owner" or "member"
  joinedAt DateTime @default(now())
  
  team     Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@unique([teamId, userId])
  @@index([userId])
}

// ============================================
// マッチデータ
// ============================================

model Match {
  matchId             String   @id
  teamId              String?
  mapId               String
  gamePodId           String?
  gameLoopZone        String?
  gameServerAddress   String?
  gameVersion         String?
  gameLengthMillis    Int?
  gameStartMillis     BigInt?
  provisioningFlowId  String?
  isCompleted         Boolean?
  customGameName      String?
  queueId             String?
  gameMode            String?
  isRanked            Boolean?
  seasonId            String?
  completionState     String?
  platformType        String?
  winningTeam         String?
  
  team                Team?     @relation(fields: [teamId], references: [id])
  players             MatchPlayer[]
  rounds              Round[]
  kills               KillEvent[]
  damageEvents        DamageEvent[]
  tags                MatchTag[]
  
  createdAt           DateTime @default(now())
  
  @@index([teamId])
}

model MatchTag {
  matchId   String
  tagName   String
  match     Match  @relation(fields: [matchId], references: [matchId], onDelete: Cascade)
  
  @@id([matchId, tagName])
}

model Player {
  puuid               String   @id
  gameName            String
  tagLine             String
  
  matches             MatchPlayer[]

  alias               String?
  mergedToPuuid       String?
  mergedTo            Player?  @relation("PlayerMerges", fields: [mergedToPuuid], references: [puuid])
  mergedFrom          Player[] @relation("PlayerMerges")
}

model MatchPlayer {
  puuid               String
  matchId             String
  teamId              String?
  partyId             String?
  characterId         String?
  competitiveTier     Int?
  accountLevel        Int?
  
  score               Int?
  roundsPlayed        Int?
  kills               Int?
  deaths              Int?
  assists             Int?
  playtimeMillis      Int?
  
  grenadeCasts        Int?
  ability1Casts       Int?
  ability2Casts       Int?
  ultimateCasts       Int?
  
  player              Player   @relation(fields: [puuid], references: [puuid])
  match               Match    @relation(fields: [matchId], references: [matchId])
  roundStats          RoundPlayerStats[]
  
  @@id([matchId, puuid])
}

model Round {
  id                  Int      @id @default(autoincrement())
  matchId             String
  roundNum            Int
  roundResult         String?
  roundCeremony       String?
  winningTeam         String?
  bombPlanter         String?
  bombDefuser         String?
  plantRoundTime      Int?
  plantLocationX      Int?
  plantLocationY      Int?
  plantSite           String?
  defuseRoundTime     Int?
  defuseLocationX     Int?
  defuseLocationY     Int?
  
  match               Match    @relation(fields: [matchId], references: [matchId])
  playerStats         RoundPlayerStats[]
  
  @@unique([matchId, roundNum])
}

model RoundPlayerStats {
  id                  Int      @id @default(autoincrement())
  matchId             String
  roundNum            Int
  puuid               String
  
  score               Int?
  kills               Int?
  deaths              Int?
  assists             Int?
  damage              Int?
  
  loadoutValue        Int?
  weapon              String?
  armor               String?
  remainingMoney      Int?
  spentMoney          Int?
  
  wasAfk              Boolean?
  wasPenalized        Boolean?
  stayedInSpawn       Boolean?
  
  matchPlayer         MatchPlayer @relation(fields: [matchId, puuid], references: [matchId, puuid])
  round               Round       @relation(fields: [matchId, roundNum], references: [matchId, roundNum])
  
  @@unique([matchId, roundNum, puuid])
}

model KillEvent {
  id                  Int      @id @default(autoincrement())
  matchId             String
  roundNum            Int?
  gameTime            Int?
  roundTime           Int?
  killerId            String?
  victimId            String?
  victimLocationX     Int?
  victimLocationY     Int?
  
  damageType          String?
  damageItem          String?
  isSecondaryFireMode Boolean?
  
  assistants          Json?
  playerLocations     Json?
  
  match               Match    @relation(fields: [matchId], references: [matchId])
}

model DamageEvent {
  id                  Int      @id @default(autoincrement())
  matchId             String
  roundNum            Int
  attackerId          String?
  receiverId          String?
  damage              Int
  legshots            Int?
  bodyshots           Int?
  headshots           Int?
  
  match               Match    @relation(fields: [matchId], references: [matchId])
}
